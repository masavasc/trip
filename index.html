<!-- ここにモーダルHTML挿入 -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:#fff; padding:1em; border-radius:8px; max-width:400px; width:90%;">
    <h3>訪問先の編集</h3>
    <input id="modalPlace" placeholder="訪問先名">
    <textarea id="modalComment" placeholder="コメント"></textarea>
    <input id="modalURL" placeholder="URL（任意）">
    <button id="saveModal">保存</button>
    <button onclick="document.getElementById('modal').style.display='none';">キャンセル</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD0LzT1F1ic5ckZVGTOzr27S8nMQwd0P6U",
    authDomain: "kyoto-trip-faec7.firebaseapp.com",
    projectId: "kyoto-trip-faec7",
    storageBucket: "kyoto-trip-faec7.appspot.com",
    messagingSenderId: "415949031642",
    appId: "1:415949031642:web:31e816026649521699fde3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let currentSlot = '', currentCell = null;

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('td[data-slot]').forEach(cell => {
      cell.addEventListener('click', () => {
        currentSlot = cell.getAttribute('data-slot');
        currentCell = cell;
        document.getElementById('modalPlace').value = '';
        document.getElementById('modalComment').value = '';
        document.getElementById('modalURL').value = '';
        document.getElementById('modal').style.display = 'flex';
      });
    });

    document.getElementById('saveModal').addEventListener('click', async () => {
      const place = document.getElementById('modalPlace').value;
      const comment = document.getElementById('modalComment').value;
      const url = document.getElementById('modalURL').value;
      const [date, time] = currentSlot.split(' ');

      const q = query(collection(db, "visits"), orderBy("timestamp"));
      const snapshot = await getDocs(q);
      const sameSlotDocs = snapshot.docs.filter(doc => doc.data().datetime === currentSlot);

      if (sameSlotDocs.length >= 3) {
        await deleteDoc(doc(db, "visits", sameSlotDocs[0].id));
      }

      await addDoc(collection(db, "visits"), { datetime: currentSlot, date, time, place, comment, url, timestamp: new Date() });
      document.getElementById('modal').style.display = 'none';
    });

    const q = query(collection(db, "visits"), orderBy("timestamp"));
    onSnapshot(q, (snapshot) => {
      const grouped = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        if (!grouped[data.datetime]) grouped[data.datetime] = [];
        grouped[data.datetime].push({ ...data, id: doc.id });
      });

      document.querySelectorAll('td[data-slot]').forEach(cell => {
        const slot = cell.getAttribute('data-slot');
        const entries = grouped[slot] || [];
        cell.innerHTML = entries.map(e => `
          <div>
            ${e.place}<br>${e.comment}<br>${e.url ? `<a href='${e.url}' target='_blank'>リンク</a>` : ''}
            <button onclick="deleteEntry('${e.id}')">❌</button>
          </div>
        `).join('');
      });
    });
  });

  window.deleteEntry = async function(id) {
    if (confirm("この予定を削除しますか？")) {
      await deleteDoc(doc(db, "visits", id));
    }
  }
</script>
